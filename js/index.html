    <html>
    <head>
    </head>
    <body>
    <h1> Websocket test </h1>

    <script src="flatbuffers.js"></script>
    <script src="thymio_generated.js"></script>
    <script type="text/javascript">
    class Node {
        constructor(id, status) {
            this._id = id;
            this._status = status;
        }
        get id() {
            return this._id
        }
        get status() {
            return this._status
        }
        get status_str() {
            switch(this.status) {
                case mobsya.fb.NodeStatus.connected: return "connected"
                case mobsya.fb.NodeStatus.ready: return "ready"
                case mobsya.fb.NodeStatus.busy: return "busy"
                case mobsya.fb.NodeStatus.disconnected: return "disconnected"
            }
            return "unknow"
        }
    }
    Node.Status = mobsya.fb.NodeStatus;

    /* Wrap a promise to allow external resolve */
    class Request extends Promise {
        constructor(promise) {
            super(promise)
        }

        get node_id() {
            return this._node_id
        }

        _trigger_error(err) {
            this._onerror(err)
        }

        _trigger_then(...args) {
           return this._then.apply(this, args);
        }

        static create(request_id, node_id) {
            var then    = undefined;
            var onerror = undefined;
            let p = new Request(function(resolve, reject){
                then    = resolve;
                onerror = reject;
            }.bind(this));
            p._then = then
            p._onerror = onerror
            p._request_id = request_id
            p._node_id = node_id
            return p
        }
    }
    Request.ErrorType = mobsya.fb.ErrorType;

    class AsebaVMDescription {
        constructor() {
            this.bytecode_size = this.data_size = this.stack_size = 0;
            this.variables = []
            this.functions = []
            this.events    = []
        }
    }

    class MobsyaClient {

        constructor(url) {
            this.socket = new WebSocket(url)
            this.socket.binaryType = 'arraybuffer';
            this.socket.onopen = this.onopen.bind(this)
            this.socket.onmessage = this.onmessage.bind(this)
            this.requests = new Map();
        }

        onopen(event) {
            console.log("connected")
        }

        on_nodes_changed(nodes) {
            console.log("unimplemented")
        }

        onmessage (event) {
            let data = new Uint8Array(event.data)
            let buf  = new flatbuffers.ByteBuffer(data);

            let message = mobsya.fb.Message.getRootAsMessage(buf, null)
            switch(message.messageType()) {
                case mobsya.fb.AnyMessage.NodesChanged: {
                    this.on_nodes_changed(this._nodes_changed_as_node_list(message.message(new mobsya.fb.NodesChanged())))
                    break;
                }
                case mobsya.fb.AnyMessage.NodeAsebaVMDescription: {
                    let msg = message.message(new mobsya.fb.NodeAsebaVMDescription())
                    const id = msg.nodeId()
                    this.on_aseba_vm_description(id, this._unserialize_aseba_vm_description(msg))
                    break;
                }
                case mobsya.fb.AnyMessage.NodeLocked: {
                    let msg = message.message(new mobsya.fb.NodeLocked())
                    let req = this._get_request(msg.requestId())
                    if(req) {
                        req._trigger_then()
                    }
                    break;
                }
                case mobsya.fb.AnyMessage.Error: {
                    let msg = message.message(new mobsya.fb.Error())
                    let req = this._get_request(msg.requestId())
                    if(req) {
                        req._trigger_error(msg.error())
                    }
                    break
                }
            }
        }

        /* request the description of the aseba vm for the node with the given id */
        request_aseba_vm_description(id) {
            let builder = new flatbuffers.Builder();
            mobsya.fb.RequestNodeAsebaVMDescription.startRequestNodeAsebaVMDescription(builder)
            mobsya.fb.RequestNodeAsebaVMDescription.addNodeId(builder, id)
            const offset = mobsya.fb.RequestNodeAsebaVMDescription.endRequestNodeAsebaVMDescription(builder)
            this._wrap_message_and_send(builder, offset, mobsya.fb.AnyMessage.RequestNodeAsebaVMDescription
            )
        }

        /* request the description of the aseba vm for the node with the given id */
        lock_node(id) {
            let builder = new flatbuffers.Builder();
            let req_id  = this._gen_request_id()

            mobsya.fb.LockNode.startLockNode(builder)
            mobsya.fb.LockNode.addRequestId(builder, req_id)
            mobsya.fb.LockNode.addNodeId(builder, id)
            let offset = mobsya.fb.LockNode.endLockNode(builder)
            this._wrap_message_and_send(builder, offset, mobsya.fb.AnyMessage.LockNode)

            let req = Request.create(req_id, id)
            this.requests.set(req_id, req)
            return req
        }

        _nodes_changed_as_node_list(msg) {
            let nodes = []
            for(let i = 0; i < msg.nodesLength(); i++) {
                const n = msg.nodes(i);
                nodes.push(new Node(n.nodeId(), n.status()))
            }
            return nodes
        }
        _unserialize_aseba_vm_description(msg) {
            let desc = new AsebaVMDescription()
            desc.bytecode_size = msg.bytecodeSize()
            desc.data_size  = msg.dataSize()
            desc.stack_size = msg.stackSize()

            for(let i = 0; i < msg.variablesLength(); i++) {
                const v = msg.variables(i);
                desc.variables.push({"name" : v.name(), "size" : v.size()})
            }

            for(let i = 0; i < msg.eventsLength(); i++) {
                const v = msg.events(i);
                desc.events.push({"name" : v.name(), "description" : v.description()})
            }

            for(let i = 0; i < msg.functionsLength(); i++) {
                const v = msg.functions(i);
                let params = []
                for(let j = 0; j < v.parametersLength(); j++) {
                    const p = v.parameters(i);
                    params.push({"name" : v.name(), "size" : p.size()})
                }
                desc.functions.push({"name" : v.name(), "description" : v.description(), "params": params})
            }
            return desc
        }

        _wrap_message_and_send(builder, offset, type) {
            mobsya.fb.Message.startMessage(builder)
            mobsya.fb.Message.addMessageType(builder, type)
            mobsya.fb.Message.addMessage(builder, offset)
            const builtMsg = mobsya.fb.Message.endMessage(builder)
            builder.finish(builtMsg);
            this.socket.send(builder.asUint8Array())
        }

        _gen_request_id(min, max) {
            let n = 0
            do {
                n = Math.floor(Math.random() * (0xffffffff - 2)) + 1
            }while(this.requests.has(n))
            return n
        }
        _get_request(id) {
            const req = this.requests.get(id)
            if(req != undefined)
                this.requests.delete(id)
             console.log(id, req)
             if(req == undefined) {
                console.error(`unknown request ${req_id}`)
            }
            return req
        }
    }

    class TestClient extends MobsyaClient {
        constructor(url) {
            super(url);
        }

        on_nodes_changed(nodes) {
            console.log(nodes)
            for (let node of nodes) {
                console.log(`${node.id} : ${node.status_str}`)
                if(node.status == Node.Status.ready) {
                    console.log(`Requesting ${node.id} description`)
                    this.request_aseba_vm_description(node.id)
                    console.log(`Locking ${node.id}`)
                    this.lock_node(node.id).then( () =>  {
                        console.log("Node locked")
                    }).catch((reason) =>  {
                        switch(err) {
                            case Request.ErrorType.node_busy:
                                console.log("Node Busy !")
                                break
                            default:
                                console.log("unknown error")
                        }
                    })
                }
            }
        }

        on_aseba_vm_description(id, desc) {
            console.log(id, desc)
        }
    }

    let client = new TestClient("ws://localhost:8597");
    </script>

    </body>
    </html>
